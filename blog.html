<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Daily Blog (Cloud)</title>
  <style>
    body { font-family: "Segoe UI", Roboto, sans-serif; margin: 0; background: #f5f7fa; color: #333; line-height: 1.6; }
    h1,h2,h3 { font-weight: 600; }
    button { cursor: pointer; border: none; transition: 0.3s ease; }
    header { background: linear-gradient(135deg, #4CAF50, #2e7d32); color: white; display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
    header h1 { font-size: 1.5rem; }
    .menu { font-size: 1.6rem; cursor: pointer; transition: transform 0.2s; }
    .menu:hover { transform: scale(1.2); }
    .container { width: 92%; max-width: 900px; margin: 25px auto; }
    #postForm { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); margin-bottom: 30px; display: none; animation: fadeIn 0.4s ease; }
    #postForm h2 { margin-top: 0; color: #2e7d32; font-size: 1.3rem; }
    textarea, input { width: 100%; padding: 12px; margin: 10px 0; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.2s; }
    textarea:focus, input:focus { border-color: #4CAF50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.3); }
    .btn { background: #4CAF50; color: white; padding: 10px 16px; font-size: 0.95rem; border-radius: 6px; margin: 3px; }
    .btn:hover { background: #388e3c; }
    .post { background: white; padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; transition: transform 0.25s ease, box-shadow 0.25s ease; white-space: pre-line; }
    .post:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .post h2 { margin: 0 0 5px; font-size: 1.4rem; color: #2e7d32; }
    .date { font-size: 0.9rem; color: #777; margin-bottom: 10px; }
    .author { font-size: 0.95rem; font-style: italic; color: #444; margin-bottom: 10px; }
    .action-btns { position: absolute; top: 15px; right: 15px; }
    .delete-btn { background: #e53935; }
    .delete-btn:hover { background: #b71c1c; }
    .edit-btn { background: #1976d2; }
    .edit-btn:hover { background: #0d47a1; }
    #loginPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.25); width: 320px; text-align: center; z-index: 1000; animation: popup 0.3s ease forwards; }
    #loginPopup h3 { margin-top: 0; color: #2e7d32; font-size: 1.2rem; }
    #overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.55); z-index: 900; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    @keyframes popup { from {opacity:0; transform: translate(-50%,-50%) scale(0.8);} to {opacity:1; transform: translate(-50%,-50%) scale(1);} }
    .top-actions { display:flex; gap:.5rem; align-items:center; }
  </style>
</head>
<body>
  <header>
    <h1>üìñ My Daily Blog</h1>
    <div class="top-actions">
      <button id="newPostBtn" class="btn" style="display:none" title="Toggle new post form">‚ûï New Post</button>
      <div class="menu" id="authBtn" title="Login">üîí</div>
    </div>
  </header>

  <div class="container">
    <div id="postForm">
      <h2>‚úçÔ∏è Write a New Blog</h2>
      <input type="text" id="title" placeholder="Blog Title" />
      <textarea id="content" rows="6" placeholder="Write your blog here..."></textarea>
      <button class="btn" id="publishBtn">Publish</button>
      <button class="btn" id="cancelEditBtn" style="display:none;background:#aaa">Cancel</button>
    </div>

    <h2 style="color:#2e7d32;">üìå All Blogs</h2>
    <div id="posts"></div>
  </div>

  <div id="overlay"></div>
  <div id="loginPopup">
    <h3>üîë Admin Login</h3>
    <input type="email" id="email" placeholder="Email (admin)" />
    <input type="password" id="password" placeholder="Password" />
    <br /><br />
    <button class="btn" id="loginBtn">Login</button>
    <button class="btn" style="background:#aaa;" id="cancelLoginBtn">Cancel</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBCZnGA4CjGtwrXB6ReBLC0fGJ7W2umLyE",
      authDomain: "myblog-92f5b.firebaseapp.com",
      projectId: "myblog-92f5b",
      storageBucket: "myblog-92f5b.firebasestorage.app",
      messagingSenderId: "720559345713",
      appId: "1:720559345713:web:a17e12880350033ec60510",
      measurementId: "G-RJ7L5T4KXH"
    };

    const ADMIN_UID = "RuMCWLXgosgByg2jZXHIdeU97y42";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const state = { isAdmin: false, editingId: null };
    const overlay = document.getElementById("overlay");
    const loginPopup = document.getElementById("loginPopup");
    const authBtn = document.getElementById("authBtn");
    const loginBtn = document.getElementById("loginBtn");
    const cancelLoginBtn = document.getElementById("cancelLoginBtn");
    const newPostBtn = document.getElementById("newPostBtn");
    const postForm = document.getElementById("postForm");
    const publishBtn = document.getElementById("publishBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const titleEl = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const postsContainer = document.getElementById("posts");

    function showLogin() { loginPopup.style.display = "block"; overlay.style.display = "block"; }
    function closeLogin() { loginPopup.style.display = "none"; overlay.style.display = "none"; }

    authBtn.addEventListener("click", () => {
      if (state.isAdmin) signOut(auth);
      else showLogin();
    });

    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        closeLogin();
      } catch (err) {
        console.error(err);
        alert("‚ùå Login failed. Check email/password.");
      }
    });

    cancelLoginBtn.addEventListener("click", closeLogin);
    newPostBtn.addEventListener("click", () => postForm.style.display = postForm.style.display === "none" ? "block" : "none");
    cancelEditBtn.addEventListener("click", resetEditor);

    onAuthStateChanged(auth, (user) => {
      state.isAdmin = !!(user && user.uid === ADMIN_UID);
      authBtn.textContent = state.isAdmin ? "üîì" : "üîí";
      authBtn.title = state.isAdmin ? "Logout" : "Login";
      newPostBtn.style.display = state.isAdmin ? "inline-block" : "none";
      postForm.style.display = state.isAdmin ? "block" : "none";
    });

    function resetEditor() {
      state.editingId = null;
      titleEl.value = "";
      contentEl.value = "";
      publishBtn.textContent = "Publish";
      cancelEditBtn.style.display = "none";
    }

    publishBtn.addEventListener("click", async () => {
      const title = titleEl.value.trim();
      const content = contentEl.value.trim();
      if (!title || !content) return alert("Please enter both title and content.");
      try {
        if (state.editingId) {
          await updateDoc(doc(db, "posts", state.editingId), { title, content, updatedAt: serverTimestamp() });
          alert("‚úèÔ∏è Blog updated!");
        } else {
          await addDoc(collection(db, "posts"), {
            title, content, author: "Pratik Timsina", createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          alert("‚úÖ Blog added!");
        }
        resetEditor();
      } catch (e) {
        console.error(e);
        alert("Failed. Check Firebase rules & auth.");
      }
    });

    async function deletePost(id) {
      if (!confirm("Are you sure you want to delete this blog?")) return;
      try { await deleteDoc(doc(db, "posts", id)); } 
      catch (e) { console.error(e); alert("Delete failed."); }
    }

    function editPost(id, data) {
      titleEl.value = data.title;
      contentEl.value = data.content;
      postForm.style.display = "block";
      publishBtn.textContent = "Update Blog";
      cancelEditBtn.style.display = "inline-block";
      state.editingId = id;
    }

    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[c]);
    }

    // üîπ Real-time Firestore Updates (NO DUPLICATES)
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      postsContainer.innerHTML = "";
      if (snap.empty) {
        postsContainer.innerHTML = `<p style="color:#666">No posts yet. ${state.isAdmin ? "Write your first post above!" : "Check back later."}</p>`;
        return;
      }
      snap.forEach((d) => {
        const data = d.data();
        const div = document.createElement("div");
        div.classList.add("post");
        const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
        const dateText = createdAt.toLocaleString();
        div.innerHTML = `
          <h2>${escapeHtml(data.title || "Untitled")}</h2>
          <div class="author">‚úçÔ∏è Author: ${escapeHtml(data.author || "Pratik Timsina")}</div>
          <div class="date">${dateText}</div>
          <p>${escapeHtml(data.content || "")}</p>
          ${state.isAdmin ? `
            <div class="action-btns">
              <button class="btn edit-btn" data-id="${d.id}">‚úèÔ∏è Edit</button>
              <button class="btn delete-btn" data-id="${d.id}">üóëÔ∏è Delete</button>
            </div>` : ""}
        `;
        postsContainer.appendChild(div);

        if (state.isAdmin) {
          div.querySelector('.edit-btn')?.addEventListener('click', () => editPost(d.id, data));
          div.querySelector('.delete-btn')?.addEventListener('click', () => deletePost(d.id));
        }
      });
    });
  </script>
</body>
</html>
